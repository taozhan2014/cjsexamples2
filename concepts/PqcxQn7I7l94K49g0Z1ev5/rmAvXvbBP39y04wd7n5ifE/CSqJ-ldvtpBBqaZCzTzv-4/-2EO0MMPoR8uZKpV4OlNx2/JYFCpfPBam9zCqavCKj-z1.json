{
  "uri" : "local://JYFCpfPBam9zCqavCKj-z1/",
  "name" : "main.js",
  "category" : "js",
  "parent" : "local://-2EO0MMPoR8uZKpV4OlNx2/",
  "pname" : "IssueToActionView",
  "flags" : "U",
  "lvars" : [ ],
  "vars" : [ {
    "name" : "jsContent",
    "expr" : {
      "str" : "var anchorUri = $cjs.getAnchorObj().uri;\nvar uriComponents = purl(anchorUri);\nvar anchorUser = uriComponents.segment()[0];\n\nfunction getLocation(handleLocation) {\n    if (navigator.geolocation) {\n        navigator.geolocation.getCurrentPosition(handleLocation);\n    } else { \n        throw Error(\"Geolocation is not supported by this browser.\");\n    }\n}\n\nfunction IssueVM(searchResult){\n    var self = this;\n    this.searchResult = searchResult;\n                \n    this.prettySubmitDate = ko.computed(function(){\n        return \"submitted \" + prettyDate(new Date(Date.parse(this.searchResult._source.createTime)));\n    }, this);\n    \n    this.issue = ko.observable(this.searchResult._source.issue);\n    this.audience = ko.observable(this.searchResult._source.audience);\n    this.reason = ko.observable(this.searchResult._source.reason);\n    \n    this.viewIssue = function(){\n        $cjs.redirect(this.searchResult._source.uri);\n    }\n}\n\nfunction IssueToActionVM(){\n    var self = this;\n    \n    this.issues = ko.observableArray();\n    this.noResult = ko.observable(false);\n    this.showAllIssuesFlag = ko.observable(false);\n    \n    var $issueForm = $('[role=issue-form]');\n    var $issueResults = $('[role=issue-results]');\n    \n    this.showIssueSubmit = function(){\n        $issueForm.parent().removeClass(\"hidden\");\n        $issueForm.parent().removeClass(\"fadeOutUp\");\n        $issueForm.parent().addClass(\"animated fadeInDown\");\n        $issueResults.removeClass(\"fadeInUp\");\n        $issueResults.addClass(\"animated fadeOutDown\");\n        $issueResults.addClass(\"hidden\");\n    }\n    \n    this.showIssueResults = function() {\n\n        $issueForm.parent().addClass(\"hidden\");\n        $issueResults.removeClass(\"hidden\");\n        $issueResults.removeClass(\"fadeOutDown\");\n        $issueResults.addClass(\"animated fadeInUp\");\n    }\n    \n    this.showAllIssues = function(){\n        this.search({\"matchAll\": true, \"from\": 0, \"size\": 1000});\n        this.showAllIssuesFlag(true);\n\n        this.showIssueResults();\n    }\n    \n    this.owner = ko.computed(function(){\n        return $cjs.currentUser == anchorUser;\n    }, this)\n    \n    this.delConcDialog = new DialogVM();\n                \n    this.deleteIssue = function(data, env){\n        self.delConcDialog.show(function() {  \n            $cjs(data.searchResult._source.uri).del();\n            self.issues.remove(data);\n        });                    \n    };\n    \n    this.search = function(options){\n        var searchArray = [];\n        var queryJson;\n        if (options.matchAll){\n            queryJson = {\n                \"match_all\": { }\n            };\n        }else{\n            queryJson = {\n                \"query_string\": { \n                    \"query\" : options.issueTags.concat(options.audienceTags).concat(options.reasonTags).join(\" \")\n                }\n            };\n        }\n        searchArray.push(queryJson);\n        searchArray.push({\n            \"prefix\" : { \"repo\" : \"/\"+anchorUser }\n        });\n        processSearchJson = {\n            \"bool\" : {\n                \"must\" : searchArray\n            }\n        };\n        var sortJson = [{\"field\" : \"createTime\", \"order\" : \"DESC\"}];\n        $cjs.search({\n            uri: \"local://f6Lu81s_9u9QcqINqsR5FA/\",\n            queryJson: processSearchJson,\n            sortJson: sortJson,\n            from: options.from,\n            size: options.size,\n            done : function(data){\n                console.log(\"search data:\"+JSON.stringify(data));\n                self.issues.removeAll();\n                if (data.hits.total > 0){   \n                    _.each(data.hits.hits, function(x){\n                        self.issues.push(new IssueVM(x));\n                    });\n                    \n                    $(\"[role=agreements]\").html(data.hits.total);\n                }else{\n                    self.noResult(true);\n                }\n            },\n            fail : function(jqXHR, textStatus, errorThrown){\n                console.log(\"failed to search concept value, response:\"+jqXHR.responseText);\n                }\n            });\n    }\n}\n\nvar issueToActionVM = new IssueToActionVM();\nko.applyBindings(issueToActionVM);\n\n$(document).ready(function(){\n    \"use strict\";\n    var $issueForm = $('[role=issue-form]');\n    var $issueResults = $('[role=issue-results]');\n    var currentIssue = {\n        issue: \"\",\n        audience: \"\",\n        reason: \"\"\n    };\n\n    function showIssueResults() {\n\n        $issueForm.parent().addClass(\"hidden\");\n        $issueResults.removeClass(\"hidden\");\n        $issueResults.removeClass(\"fadeOutDown\");\n        $issueResults.addClass(\"animated fadeInUp\");\n    }\n\n\n    function doIssueResults() {\n\n        $(\"[role=submitted-issue]\").html(currentIssue.issue);\n        $(\"[role=submitted-audience]\").html(currentIssue.audience);\n        $(\"[role=submitted-reason]\").html(currentIssue.reason);\n\n        var issueTags = currentIssue.issue.split(\" \").filter(function(s){ return s.length > 3;});\n        var audienceTags = currentIssue.audience.split(\" \").filter(function(s){ return s.length > 3;});\n        var reasonTags = currentIssue.reason.split(\" \").filter(function(s){ return s.length > 3;});\n\n        issueTags.concat(audienceTags).concat(reasonTags).forEach(function(s){\n            $(\"[role=tag-list]\").append(\"<li class='tag'>\"+s+\"</li>\");\n        });\n        \n        issueToActionVM.showAllIssuesFlag(false);\n        issueToActionVM.search({\"issueTags\": issueTags, \"audienceTags\": audienceTags, \"reasonTags\": reasonTags, \"from\" : 0, \"size\": 5});\n\n        showIssueResults();\n    }\n\n    function handleSubmit(e) {\n        $(\"#spin\").removeClass(\"hidden\");\n\n        e.preventDefault();\n        var $form = $(e.target),\n            $target = $(e.target).parent();\n\n        currentIssue.issue = $form.find('input[name=issue]').val();\n        currentIssue.audience = $form.find('input[name=audience]').val();\n        currentIssue.reason = $form.find('input[name=reason]').val();\n        \n        var handleLocation = function(position){\n            var issueToActionViewConc = $cjs(anchorUri).as(\"local://-2EO0MMPoR8uZKpV4OlNx2/\");\n            var newIssue = {\n                issue : currentIssue.issue,\n                audience: currentIssue.audience,\n                reason: currentIssue.reason,\n                createTime: (new Date()).toISOString(),\n                location: {\"lat\" : position.coords.latitude, \"lon\" : position.coords.longitude}\n            }\n            issueToActionViewConc.execute('addIssue', [anchorUri, newIssue, \"local://TNRWsZkMFJ9CCKGLt-Ri-0/\"], \n                function(uri){                    \n                    if (uri){\n                        $cjs(uri);\n                        \n                        $target.removeClass('fadeInDown');\n            \n                        $target\n                            .addClass('animated fadeOutUp')\n                            .one('webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend', doIssueResults);\n                            \n                        $(\"#spin\").addClass(\"hidden\");\n                    }\n                },\n                function(jqXHR, textStatus, errorThrown){\n                    console.log(\"execute proxy method addIssue failed, status:\" + textStatus + \", error:\" + errorThrown + \", server response:\" + ((jqXHR.responseText)?jqXHR.responseText:\"\"));\n                });\n        }\n            \n        getLocation(handleLocation);\n    }\n\n\n\n    $issueForm.submit(handleSubmit);\n});\n",
      "strEditMode" : "js"
    }
  }, {
    "name" : "_javascriptResource_fileName",
    "expr" : {
      "str" : "main.js",
      "strEditMode" : ""
    }
  }, {
    "name" : "javascriptResource",
    "expr" : {
      "concept" : "/common/core/nK_9eZMUDp8T6qqr7t5k67/",
      "conceptName" : "Javascript Resource",
      "bindings" : {
        "js" : "jsContent",
        "fileName" : "_javascriptResource_fileName"
      }
    }
  } ],
  "isas" : [ {
    "var" : "javascriptResource"
  } ],
  "isLambda" : false,
  "digest" : "iko7by488rV/l60Dnfz6Ww=="
}